{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "metadata": {
        "description": "Deploy Custom Extension Runner with Easy Auth delegated permissions"
    },
    "parameters": {
        "appName": {
            "type": "string",
            "defaultValue": "custom-extension-runner",
            "minLength": 2,
            "maxLength": 60,
            "metadata": {
                "description": "Name of the Custom Extension Runner app"
            }
        },
        "location": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "Azure region for deployment"
            }
        },
        "subscriptionId": {
            "type": "string",
            "defaultValue": "[subscription().subscriptionId]",
            "metadata": {
                "description": "Azure subscription ID containing the Logic Apps"
            }
        },
        "logicAppsResourceGroup": {
            "type": "string",
            "minLength": 1,
            "maxLength": 90,
            "metadata": {
                "description": "Resource Group containing your Custom Extension Logic Apps. Must exist in the same subscription."
            }
        },
        "sku": {
            "type": "string",
            "defaultValue": "B1",
            "allowedValues": ["F1", "B1", "B2", "S1", "S2", "P1V2", "P2V2"],
            "metadata": {
                "description": "App Service Plan SKU"
            }
        }
    },
    "variables": {
        "webAppName": "[parameters('appName')]",
        "appServicePlanName": "[concat('ASP-', parameters('appName'))]",
        "repoUrl": "https://github.com/ChrFrohn/Custom-Extension-Runner.git",
        "roleDefinitionId": "[concat('/subscriptions/', parameters('subscriptionId'), '/providers/Microsoft.Authorization/roleDefinitions/87a39d53-fc1b-424a-814c-f7e04687dc9e')]"
    },
    "resources": [
        {
            "type": "Microsoft.Web/serverfarms",
            "apiVersion": "2023-01-01",
            "name": "[variables('appServicePlanName')]",
            "location": "[parameters('location')]",
            "sku": {
                "name": "[parameters('sku')]"
            },
            "properties": {
                "reserved": false
            }
        },
        {
            "type": "Microsoft.Web/sites",
            "apiVersion": "2023-01-01",
            "name": "[variables('webAppName')]",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]"
            ],
            "identity": {
                "type": "SystemAssigned"
            },
            "properties": {
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('appServicePlanName'))]",
                "httpsOnly": true,
                "siteConfig": {
                    "nodeVersion": "~20",
                    "minTlsVersion": "1.2",
                    "scmMinTlsVersion": "1.2",
                    "ftpsState": "Disabled",
                    "remoteDebuggingEnabled": false,
                    "http20Enabled": true,
                    "alwaysOn": "[if(equals(parameters('sku'), 'F1'), false(), true())]",
                    "healthCheckPath": "/api/health",
                    "appSettings": [
                        {
                            "name": "AZURE_SUBSCRIPTION_ID",
                            "value": "[parameters('subscriptionId')]"
                        },
                        {
                            "name": "LOGIC_APPS_RESOURCE_GROUP",
                            "value": "[parameters('logicAppsResourceGroup')]"
                        },
                        {
                            "name": "SCM_DO_BUILD_DURING_DEPLOYMENT",
                            "value": "true"
                        },
                        {
                            "name": "NODE_ENV",
                            "value": "production"
                        }
                    ]
                }
            }
        },
        {
            "type": "Microsoft.Web/sites/sourcecontrols",
            "apiVersion": "2015-08-01",
            "name": "[concat(variables('webAppName'), '/web')]",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[resourceId('Microsoft.Web/sites', variables('webAppName'))]"
            ],
            "properties": {
                "repoUrl": "[variables('repoUrl')]",
                "branch": "main",
                "isManualIntegration": true
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2022-09-01",
            "name": "managedIdentityDelay",
            "dependsOn": [
                "[resourceId('Microsoft.Web/sites', variables('webAppName'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "resources": []
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2022-09-01",
            "name": "[concat('logicAppRoleAssignment-', copyIndex())]",
            "subscriptionId": "[parameters('subscriptionId')]",
            "resourceGroup": "[trim(split(parameters('logicAppsResourceGroup'), ',')[copyIndex()])]",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', 'managedIdentityDelay')]"
            ],
            "copy": {
                "name": "roleAssignmentCopy",
                "count": "[length(split(parameters('logicAppsResourceGroup'), ','))]"
            },
            "properties": {
                "mode": "Incremental",
                "expressionEvaluationOptions": {
                    "scope": "inner"
                },
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "principalId": {
                            "type": "string"
                        },
                        "roleDefinitionId": {
                            "type": "string"
                        },
                        "resourceGroupName": {
                            "type": "string"
                        }
                    },
                    "resources": [
                        {
                            "type": "Microsoft.Authorization/roleAssignments",
                            "apiVersion": "2022-04-01",
                            "name": "[guid(resourceGroup().id, parameters('principalId'), 'LogicAppOperator')]",
                            "properties": {
                                "roleDefinitionId": "[parameters('roleDefinitionId')]",
                                "principalId": "[parameters('principalId')]",
                                "principalType": "ServicePrincipal"
                            }
                        }
                    ]
                },
                "parameters": {
                    "principalId": {
                        "value": "[reference(resourceId('Microsoft.Web/sites', variables('webAppName')), '2023-01-01', 'full').identity.principalId]"
                    },
                    "roleDefinitionId": {
                        "value": "[variables('roleDefinitionId')]"
                    },
                    "resourceGroupName": {
                        "value": "[trim(split(parameters('logicAppsResourceGroup'), ',')[copyIndex()])]"
                    }
                }
            }
        }
    ],
    "outputs": {
        "webAppName": {
            "type": "string",
            "value": "[variables('webAppName')]"
        },
        "webAppUrl": {
            "type": "string",
            "value": "[concat('https://', reference(resourceId('Microsoft.Web/sites', variables('webAppName'))).hostNames[0])]"
        },
        "resourceGroup": {
            "type": "string",
            "value": "[resourceGroup().name]"
        },
        "subscriptionId": {
            "type": "string",
            "value": "[subscription().subscriptionId]"
        },
        "managedIdentityPrincipalId": {
            "type": "string",
            "value": "[reference(resourceId('Microsoft.Web/sites', variables('webAppName')), '2023-01-01', 'full').identity.principalId]"
        },
        "managedIdentityTenantId": {
            "type": "string",
            "value": "[reference(resourceId('Microsoft.Web/sites', variables('webAppName')), '2023-01-01', 'full').identity.tenantId]"
        },
        "easyAuthSetupInstructions": {
            "type": "string",
            "value": "NEXT STEPS: 1) Go to your App Service in Azure portal 2) Navigate to Authentication 3) Add identity provider > Microsoft 4) Configure delegated permissions: User.Read.All, LifecycleWorkflows.Read.All, EntitlementManagement.Read.All"
        },
        "requiredPermissions": {
            "type": "array",
            "value": [
                "User.Read.All - For user search functionality",
                "LifecycleWorkflows.Read.All - For lifecycle workflow extensions", 
                "EntitlementManagement.Read.All - For entitlement management extensions"
            ]
        }
    }
}
